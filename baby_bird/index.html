<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Baby Bird</title>
<!--   <link href="http://fonts.googleapis.com/css?family=Josefin+Sans" rel="stylesheet" type="text/css">
 --></head>
<script src="jquery-2.1.3.min.js"></script>
<script>
$(function() {
  var pos = 50;
  var obsDelay = 1000;
  var speed = 0.008;
  var last_char_move = new Date();
  var last_obs = new Date();
  var last_obs_move = new Date();
  var start_date = new Date();
  var $bird = $('.bird');
  var $body = $('body');

  $(document).on('mousedown touchstart', function() {
    if($body.hasClass('gg')) {
      // body에서 gg제거하고
      // pos를 50으로 수정
      $body.removeClass('gg');
      $('.obstacle').remove();
      pos = 50;
      obsDelay = 1000;
      speed = 0.008;
      start_date = new Date();
    } else {
      $bird.addClass('up');
      $bird.removeClass('down');
    }
  });
  $(document).on('mouseup touchend', function() {
    if($body.hasClass('gg')) {
    } else {
      $bird.addClass('down');
      $bird.removeClass('up');
    }
  });

  function update() {
    requestAnimationFrame(update);
    if($body.hasClass('gg')) return;

    var cur_date = new Date();

    // 캐릭터 이동
    if(cur_date - last_char_move > 10) {
      if($bird.hasClass('up')) {
        pos = pos - 1;
      } else {
        pos = pos + 1;
      }
      $bird.css('top', pos + '%');

      // 화면 경계에 닿으면 종료
      if(pos === 0 || pos === 100) {
        $body.addClass('gg');
      }
      last_char_move = cur_date;
    }
    
    // 점수 갱신
    $('.score').text(parseInt((cur_date - start_date) / 100));

    // 장애물 추가
    if(cur_date - last_obs > obsDelay) {
      var types = ['moon', 'cloud', 'flower' , 'planet' , 'planet2'];
      var index = Math.floor(Math.random() * types.length);
      
      var obs = $('<div class="obstacle ' + types[index] + '"></div>');
      $body.append(obs);
      obs.css('left', '100%');
      obs.css('top', (Math.random() * 100) + '%');

      last_obs = cur_date;
    }

    // 장애물 이동
    var cur_date = new Date();
    var windowWidth = $(window).width();
    if(cur_date - last_obs_move > 10) {
      var charx = $bird.offset().left;
      var chary = $bird.offset().top;
      var charr = $bird.width() * 0.5;

      $('.obstacle').each(function(i, element) {
        var $element = $(element);
        var left = parseInt($element.css('left'));
        var percent = left /  windowWidth;
        percent = percent - speed;

        $(element).css('left', (percent * windowWidth) + 'px');

        if(left < 0) {
          // 사라진 애들 제거
          $(element).remove();
          obsDelay = obsDelay * 0.99;
          speed = speed * 1.01;
        } else {
          // 충돌 검사
          var obsOffset = $element.offset();
          var obsx = obsOffset.left;
          var obsy = obsOffset.top;
          var obsr = $element.width() * 0.5;
          var distance = Math.pow(Math.pow(obsx - charx, 2) + Math.pow(obsy - chary, 2), 0.5);
          if(distance < (obsr + charr) * 0.9) {
            $body.addClass('gg');
          }
        }
      });
      last_obs_move = cur_date;
    }
  }

  requestAnimationFrame(update);
});

</script>
<style>
.bird {
  position: fixed;
  top: 50%;
  left: 40%;
  width: 10vw;
  height: 10vw;
  background-image: url(img/js.png);
  background-repeat: no-repeat;
  background-size: cover;
}
.bird.down {
  transform: rotate(10deg);
}
.bird.up {
  transform: rotate(-10deg);
}
.gg .bird.up,
.gg .bird.down {
  transform: rotate(180deg);
}

html {
  height: 100%;
}
body {
  background-image: linear-gradient( to bottom, #000000, #00225e );
  height: 100%;
  overflow: hidden;
}
body > .gameover {
  position: fixed;
  top:50%;
  left:50%;
  display: none;
}
body.gg > .gameover {
  font-size: 5vw;
  display: block;
  color: #ffffff;
  font-family: 'Josefin Sans', sans-serif;
  z-index: 1;
}
.obstacle {
  background-repeat: no-repeat;
  background-size: cover;
  position: absolute;
}
.obstacle.moon {
  width: 10vw;
  height: 10vw;
  background-image: url(img/moon.png);
}
.obstacle.cloud {
  width: 15vw;
  height: 15vw;
  background-image: url(img/cloud.png);

}
.obstacle.flower {
  width: 10vw;
  height: 10vw;
  background-image: url(img/flower.png);
}
.obstacle.planet2 {
  width: 10vw;
  height: 10vw;
  background-image: url(img/planet2.png);
}
.obstacle.planet {
  width: 10vw;
  height: 10vw;
  background-image: url(img/planet.png);
}
.score {
  position: absolute;
  left: 10px;
  top: 10px;
  font-size: 3em;
  color: white;
}
</style>
<body>
  <div class="bird down"></div>
  <div class="gameover">GAME OVER</div>
  <div class="score">0</div>
</body>
</html>
